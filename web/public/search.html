<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search - TheSafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="font-sans bg-gradient-to-br from-slate-50 to-orange-50 min-h-screen">
    <nav class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-orange-100">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="forum.html" class="text-gray-700 hover:text-orange-600">Back</a>
                <div class="flex items-center gap-4">
                    <div id="network-status" class="flex items-center gap-2 text-sm">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                        <span id="status-text" class="text-gray-600">Checking connection...</span>
                    </div>
                    <a href="messages.html" class="text-gray-700 hover:text-orange-600">Messages</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center gap-2">
                <input id="q" placeholder="Search users or posts" class="flex-1 border rounded-full px-4 py-2" />
                <button id="go" class="px-4 py-2 border rounded">Search</button>
            </div>
        </div>
        <div class="grid lg:grid-cols-3 gap-6 mt-6">
            <section class="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h2 class="font-semibold mb-3">Top results</h2>
                <div id="mixed" class="space-y-3 text-sm"></div>
            </section>
            <aside class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h2 class="font-semibold mb-3">Filters</h2>
                <div class="space-y-2 text-sm text-gray-600">
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-users" checked/> Users</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-posts" checked/> Posts</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-recent" checked/> Boost recent</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-trending"/> Boost trending</label>
                </div>
            </aside>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase } from './js/supabase.js';
        import { networkMonitor } from './js/ui.js';
        
        initSupabase();
        
        // Initialize network monitoring
        networkMonitor.addListener((isOnline) => {
            if (!isOnline) {
                mixed.innerHTML = '<div class="text-red-600 text-center py-4">‚ö†Ô∏è No internet connection. Please check your network and try again.</div>';
            }
            
            // Update network status indicator
            updateNetworkStatus(isOnline);
        });
        
        // Update network status indicator
        function updateNetworkStatus(isOnline) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (isOnline) {
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                statusText.textContent = 'Connected';
                statusText.className = 'text-green-600';
            } else {
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.textContent = 'Offline';
                statusText.className = 'text-red-600';
            }
        }
        
        // Initialize status on page load
        updateNetworkStatus(networkMonitor.checkConnectivity());
        
        const q = document.getElementById('q');
        const mixed = document.getElementById('mixed');
        const fUsers = document.getElementById('f-users');
        const fPosts = document.getElementById('f-posts');
        const fRecent = document.getElementById('f-recent');
        const fTrending = document.getElementById('f-trending');
        document.getElementById('go').addEventListener('click', run);
        q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ run(); }});
        
        // Add retry function for network requests
        async function retryRequest(requestFn, maxRetries = 3, delay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await requestFn();
                } catch (error) {
                    console.warn(`Search attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, delay * attempt));
                }
            }
        }
        
        // Check network connectivity
        function checkNetworkConnectivity() {
            return networkMonitor.checkConnectivity();
        }
        
        async function run(){
            const text = (q.value||'').trim();
            if(!text){ mixed.innerHTML=''; return; }
            
            // Check network connectivity first
            if (!checkNetworkConnectivity()) {
                mixed.innerHTML = '<div class="text-red-600 text-center py-4">‚ö†Ô∏è No internet connection. Please check your network and try again.</div>';
                return;
            }
            
            // Show loading state
            mixed.innerHTML = '<div class="text-gray-600 text-center py-4">üîç Searching...</div>';
            
            const like = `%${text}%`;
            
            try {
                // Search queries - improved to be more comprehensive with retry logic
                const searchPromises = [
                    // Exact username matches (highest priority)
                    retryRequest(() => supabase.from('profiles').select('username,display_name,profile_pic').eq('username', text).limit(5)),
                    // Partial username matches
                    retryRequest(() => supabase.from('profiles').select('username,display_name,profile_pic').ilike('username', like).limit(15)),
                    // Posts that match in title OR body (combined search)
                    retryRequest(() => supabase.from('posts').select('id,title,body,created_at,upvotes').or(`title.ilike.${like},body.ilike.${like}`).order('created_at',{ascending:false}).limit(30))
                ];
                
                const [usersExact, usersPartial, postsSearch] = await Promise.allSettled(searchPromises);
                
                let results = [];
                const now = Date.now();
                
                function timeBoost(ts){ 
                    if(!fRecent.checked) return 0; 
                    const ageH = (now - new Date(ts).getTime())/(1000*60*60); 
                    return Math.max(0, 24 - ageH) * 0.5; 
                }
                
                function trendBoost(up){ 
                    return fTrending.checked ? Math.min(5, (up||0)/5) : 0; 
                }
                
                // Check if any requests failed
                const failedRequests = [usersExact, usersPartial, postsSearch].filter(req => req.status === 'rejected');
                if (failedRequests.length > 0) {
                    console.warn('Some search requests failed:', failedRequests);
                }
                
                // Add user results
                if (fUsers.checked){
                    // Exact username matches get highest score
                    if (usersExact.status === 'fulfilled' && usersExact.value.data) {
                        usersExact.value.data.forEach(u=>results.push({
                            type:'user', 
                            key:u.username, 
                            score:100, 
                            item:u
                        }));
                    }
                    
                    // Partial username matches
                    if (usersPartial.status === 'fulfilled' && usersPartial.value.data) {
                        usersPartial.value.data.forEach(u=>{
                            // Skip if already added as exact match
                            if (!results.find(r => r.type === 'user' && r.key === u.username)) {
                                results.push({
                                    type:'user', 
                                    key:u.username, 
                                    score:70, 
                                    item:u
                                });
                            }
                        });
                    }
                }
                
                // Add post results
                if (fPosts.checked){
                    if (postsSearch.status === 'fulfilled' && postsSearch.value.data) {
                        postsSearch.value.data.forEach(p=>{
                            let score = 50; // Base score for posts
                            
                            // Boost if title matches (title matches are more important)
                            if (p.title && p.title.toLowerCase().includes(text.toLowerCase())) {
                                score += 20;
                            }
                            
                            // Boost if body matches
                            if (p.body && p.body.toLowerCase().includes(text.toLowerCase())) {
                                score += 10;
                            }
                            
                            // Add time and trend boosts
                            score += timeBoost(p.created_at) + trendBoost(p.upvotes);
                            
                            results.push({
                                type:'post', 
                                key:p.id, 
                                score:score, 
                                item:p
                            });
                        });
                    }
                }
                
                // Sort by score (highest first), then by recency for same scores
                const ranked = results.sort((a,b)=>{
                    if (b.score !== a.score) return b.score - a.score;
                    // If scores are equal, sort by recency
                    if (a.type === 'post' && b.type === 'post') {
                        return new Date(b.item.created_at) - new Date(a.item.created_at);
                    }
                    // Users come before posts if scores are equal
                    if (a.type === 'user' && b.type === 'post') return -1;
                    if (a.type === 'post' && b.type === 'user') return 1;
                    return 0;
                }).slice(0,30);
                
                if (ranked.length === 0) {
                    mixed.innerHTML = '<div class="text-gray-500 text-center py-4">No results found</div>';
                } else {
                    mixed.innerHTML = ranked.map(r=> r.type==='user' ? renderUser(r.item) : renderPost(r.item)).join('');
                }
                
            } catch (error) {
                console.error('Search error:', error);
                
                // Provide user-friendly error messages
                let errorMessage = 'Search failed. Please try again.';
                if (error.message?.includes('network') || error.message?.includes('fetch')) {
                    errorMessage = '‚ö†Ô∏è Network error. Please check your internet connection and try again.';
                } else if (error.message?.includes('timeout')) {
                    errorMessage = '‚è±Ô∏è Request timed out. Please try again.';
                }
                
                mixed.innerHTML = `<div class="text-red-600 text-center py-4">${errorMessage}</div>`;
            }
        }
        function renderUser(u){
            return `<div class="flex items-center justify-between px-3 py-2 border rounded-xl hover:bg-gray-50 transition-colors">
                <div class="flex items-center gap-3 min-w-0">
                    <img src="${u.profile_pic||'/avatar.png'}" class="w-10 h-10 rounded-full"/>
                    <div class="min-w-0">
                        <div class="flex items-center gap-2">
                            <a href="user.html?u=${encodeURIComponent(u.username)}" class="font-medium text-gray-800">@${u.username}</a>
                            <span class="text-xs text-gray-500 bg-blue-100 px-2 py-1 rounded">User</span>
                        </div>
                        <div class="text-xs text-gray-500 truncate">${u.display_name||''}</div>
                    </div>
                </div>
                <a class="text-xs px-3 py-1 rounded-full border border-gray-300 hover:bg-gray-100 transition-colors" href="messages.html?to=${encodeURIComponent(u.username)}">Message</a>
            </div>`;
        }
        function renderPost(p){
            const excerpt = (p.body||'').replace(/\s+/g,' ').slice(0,150);
            const t = new Date(p.created_at).toLocaleString();
            const upvotes = p.upvotes || 0;
            return `<a class="block p-3 border rounded-xl hover:bg-gray-50 transition-colors" href="thread.html?id=${p.id}">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Post</div>
                    <div class="text-xs text-gray-500">${t}</div>
                </div>
                <div class="font-semibold text-gray-800 mb-1">${p.title?escapeHtml(p.title):'Post'}</div>
                <div class="text-sm text-gray-700 mb-2">${escapeHtml(excerpt)}${excerpt.length===150?'‚Ä¶':''}</div>
                <div class="flex items-center text-xs text-gray-500">
                    <span class="mr-3">üëç ${upvotes}</span>
                    <span>üìù Forum</span>
                </div>
            </a>`;
        }
        function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
        const qp = new URLSearchParams(location.search); if(qp.get('q')){ q.value = qp.get('q'); run(); }
        [fUsers,fPosts,fRecent,fTrending].forEach(x=>x.addEventListener('change', run));
    </script>
</body>
</html>



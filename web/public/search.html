<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search - TheSafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="font-sans bg-gradient-to-br from-slate-50 to-orange-50 min-h-screen">
    <nav class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-orange-100">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="forum.html" class="text-gray-700 hover:text-orange-600">Back</a>
                <a href="messages.html" class="text-gray-700 hover:text-orange-600">Messages</a>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center gap-2">
                <input id="q" placeholder="Search users or posts" class="flex-1 border rounded-full px-4 py-2" />
                <button id="go" class="px-4 py-2 border rounded">Search</button>
            </div>
        </div>
        <div class="grid lg:grid-cols-3 gap-6 mt-6">
            <section class="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h2 class="font-semibold mb-3">Top results</h2>
                <div id="mixed" class="space-y-3 text-sm"></div>
            </section>
            <aside class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h2 class="font-semibold mb-3">Filters</h2>
                <div class="space-y-2 text-sm text-gray-600">
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-users" checked/> Users</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-posts" checked/> Posts</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-recent" checked/> Boost recent</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-trending"/> Boost trending</label>
                </div>
            </aside>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase } from './js/supabase.js';
        initSupabase();
        const q = document.getElementById('q');
        const mixed = document.getElementById('mixed');
        const fUsers = document.getElementById('f-users');
        const fPosts = document.getElementById('f-posts');
        const fRecent = document.getElementById('f-recent');
        const fTrending = document.getElementById('f-trending');
        document.getElementById('go').addEventListener('click', run);
        q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ run(); }});
        async function run(){
            const text = (q.value||'').trim();
            if(!text){ mixed.innerHTML=''; return; }
            const like = `%${text}%`;
            const prefix = text + '%';
            const [usersEq, usersIlike, postsTitle, postsBody, postsRecent] = await Promise.all([
                supabase.from('profiles').select('username,display_name,profile_pic').eq('username', text).limit(5),
                supabase.from('profiles').select('username,display_name,profile_pic').ilike('username', prefix).limit(10),
                supabase.from('posts').select('id,title,body,created_at,upvotes').ilike('title', like).limit(20),
                supabase.from('posts').select('id,title,body,created_at,upvotes').ilike('body', like).limit(20),
                supabase.from('posts').select('id,title,body,created_at,upvotes').order('created_at',{ascending:false}).limit(10)
            ]);
            let results = [];
            const now = Date.now();
            function timeBoost(ts){ if(!fRecent.checked) return 0; const ageH = (now - new Date(ts).getTime())/(1000*60*60); return Math.max(0, 24 - ageH) * 0.5; }
            function trendBoost(up){ return fTrending.checked ? Math.min(5, (up||0)/5) : 0; }
            if (fUsers.checked){
                (usersEq.data||[]).forEach(u=>results.push({type:'user', key:u.username, score:100, item:u}));
                (usersIlike.data||[]).forEach(u=>results.push({type:'user', key:u.username, score:70, item:u}));
            }
            if (fPosts.checked){
                (postsTitle.data||[]).forEach(p=>results.push({type:'post', key:p.id, score:60 + timeBoost(p.created_at) + trendBoost(p.upvotes), item:p}));
                (postsBody.data||[]).forEach(p=>results.push({type:'post', key:p.id, score:40 + timeBoost(p.created_at) + trendBoost(p.upvotes), item:p}));
                (postsRecent.data||[]).forEach(p=>results.push({type:'post', key:p.id, score:20 + timeBoost(p.created_at) + trendBoost(p.upvotes), item:p}));
            }
            // dedupe by key keeping highest score
            const best = new Map();
            for (const r of results){ const prev = best.get(r.key); if (!prev || r.score > prev.score) best.set(r.key, r); }
            const ranked = Array.from(best.values()).sort((a,b)=>b.score - a.score).slice(0,30);
            mixed.innerHTML = ranked.map(r=> r.type==='user' ? renderUser(r.item) : renderPost(r.item)).join('') || '<div class="text-gray-500">No results</div>';
        }
        function renderUser(u){
            return `<div class="flex items-center justify-between px-3 py-2 border rounded-xl">
                <div class="flex items-center gap-3 min-w-0">
                    <img src="${u.profile_pic||'/avatar.png'}" class="w-10 h-10 rounded-full"/>
                    <div class="min-w-0">
                        <a href="user.html?u=${encodeURIComponent(u.username)}" class="font-medium truncate">@${u.username}</a>
                        <div class="text-xs text-gray-500 truncate">${u.display_name||''}</div>
                    </div>
                </div>
                <a class="text-xs px-2 py-1 rounded-full border" href="messages.html?to=${encodeURIComponent(u.username)}">Message</a>
            </div>`;
        }
        function renderPost(p){
            const excerpt = (p.body||'').replace(/\s+/g,' ').slice(0,180);
            const t = new Date(p.created_at).toLocaleString();
            return `<a class="block p-3 border rounded-xl hover:bg-gray-50" href="thread.html?id=${p.id}">
                <div class="text-sm text-gray-500">${t}</div>
                <div class="font-semibold">${p.title?escapeHtml(p.title):'Post'}</div>
                <div class="text-sm text-gray-700">${escapeHtml(excerpt)}${excerpt.length===180?'â€¦':''}</div>
            </a>`;
        }
        function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
        const qp = new URLSearchParams(location.search); if(qp.get('q')){ q.value = qp.get('q'); run(); }
        [fUsers,fPosts,fRecent,fTrending].forEach(x=>x.addEventListener('change', run));
    </script>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search - TheSafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="font-sans bg-gradient-to-br from-slate-50 to-orange-50 min-h-screen">
    <nav class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-orange-100">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="forum.html" class="text-gray-700 hover:text-orange-600">Back</a>
                <div class="flex items-center gap-4">
                    <div id="network-status" class="flex items-center gap-2 text-sm">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                        <span id="status-text" class="text-gray-600">Checking connection...</span>
                    </div>
                    <a href="messages.html" class="text-gray-700 hover:text-orange-600">Messages</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
            <div class="flex items-center gap-2">
                <input id="q" placeholder="Search users or posts" class="flex-1 border rounded-full px-4 py-2" />
                <button id="go" class="px-4 py-2 border rounded">Search</button>
            </div>
        </div>
        <div class="grid lg:grid-cols-3 gap-6 mt-6">
            <section class="lg:col-span-2 bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h2 class="font-semibold mb-3">Top results</h2>
                <div id="mixed" class="space-y-3 text-sm"></div>
            </section>
            <aside class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
                <h2 class="font-semibold mb-3">Filters</h2>
                <div class="space-y-2 text-sm text-gray-600">
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-users" checked/> Users</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-posts" checked/> Posts</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-recent" checked/> Boost recent</label>
                    <label class="flex items-center gap-2"><input type="checkbox" id="f-trending"/> Boost trending</label>
                </div>
            </aside>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase } from './js/supabase.js';
        import { networkMonitor } from './js/ui.js';
        import { privacyAwareSearch, getPreviewStats, getPreviewMessage } from './js/privacySearch.js';
        
        initSupabase();
        
        // Initialize network monitoring
        networkMonitor.addListener((isOnline) => {
            if (!isOnline) {
                mixed.innerHTML = '<div class="text-red-600 text-center py-4">‚ö†Ô∏è No internet connection. Please check your network and try again.</div>';
            }
            
            // Update network status indicator
            updateNetworkStatus(isOnline);
        });
        
        // Update network status indicator
        function updateNetworkStatus(isOnline) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (isOnline) {
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                statusText.textContent = 'Connected';
                statusText.className = 'text-green-600';
            } else {
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.textContent = 'Offline';
                statusText.className = 'text-red-600';
            }
        }
        
        // Initialize status on page load
        updateNetworkStatus(networkMonitor.checkConnectivity());
        
        const q = document.getElementById('q');
        const mixed = document.getElementById('mixed');
        const fUsers = document.getElementById('f-users');
        const fPosts = document.getElementById('f-posts');
        const fRecent = document.getElementById('f-recent');
        const fTrending = document.getElementById('f-trending');
        document.getElementById('go').addEventListener('click', run);
        q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ run(); }});
        
        // Add retry function for network requests
        async function retryRequest(requestFn, maxRetries = 3, delay = 1000) {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    return await requestFn();
                } catch (error) {
                    console.warn(`Search attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, delay * attempt));
                }
            }
        }
        
        // Check network connectivity
        function checkNetworkConnectivity() {
            return networkMonitor.checkConnectivity();
        }
        
        async function run(){
            const text = (q.value||'').trim();
            if(!text){ mixed.innerHTML=''; return; }
            
            // Check network connectivity first
            if (!checkNetworkConnectivity()) {
                mixed.innerHTML = '<div class="text-red-600 text-center py-4">‚ö†Ô∏è No internet connection. Please check your network and try again.</div>';
                return;
            }
            
            // Show loading state
            mixed.innerHTML = '<div class="text-gray-600 text-center py-4">üîç Searching...</div>';
            
            try {
                // Use privacy-aware search
                const searchResult = await privacyAwareSearch(text);
                
                if (searchResult.error) {
                    mixed.innerHTML = `<div class="text-red-600 text-center py-4">Search failed: ${searchResult.error}</div>`;
                    return;
                }
                
                const { results, isAuthenticated, hasPreview } = searchResult;
                
                if (results.length === 0) {
                    mixed.innerHTML = '<div class="text-gray-500 text-center py-4">No results found</div>';
                    return;
                }
                
                // Render results
                let html = '';
                
                // Add preview banner for anonymous users
                if (hasPreview) {
                    const stats = await getPreviewStats();
                    const previewMsg = getPreviewMessage(stats);
                    
                    html += `
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-xl p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="font-semibold text-orange-800">${previewMsg.title}</h3>
                                    <p class="text-sm text-orange-700 mt-1">${previewMsg.message}</p>
                                </div>
                                <div class="flex gap-2">
                                    <a href="login.html" class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm font-medium hover:bg-orange-700 transition-colors">
                                        ${previewMsg.cta}
                                    </a>
                                    <a href="signup.html" class="px-4 py-2 border border-orange-600 text-orange-600 rounded-lg text-sm font-medium hover:bg-orange-50 transition-colors">
                                        Sign Up
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Render search results
                results.forEach(result => {
                    if (result.type === 'profile') {
                        html += renderUser(result.data, result.isPreview);
                    } else if (result.type === 'post') {
                        html += renderPost(result.data, result.isPreview);
                    }
                });
                
                mixed.innerHTML = html;
                
            } catch (error) {
                console.error('Search error:', error);
                
                // Provide user-friendly error messages
                let errorMessage = 'Search failed. Please try again.';
                if (error.message?.includes('network') || error.message?.includes('fetch')) {
                    errorMessage = '‚ö†Ô∏è Network error. Please check your internet connection and try again.';
                } else if (error.message?.includes('timeout')) {
                    errorMessage = '‚è±Ô∏è Request timed out. Please try again.';
                }
                
                mixed.innerHTML = `<div class="text-red-600 text-center py-4">${errorMessage}</div>`;
            }
        }
        
        function renderUser(u, isPreview = false){
            const previewClass = isPreview ? 'opacity-75' : '';
            const previewOverlay = isPreview ? `
                <div class="absolute inset-0 bg-gradient-to-t from-white/80 to-transparent rounded-xl pointer-events-none"></div>
            ` : '';
            
            return `
                <div class="relative ${previewClass}">
                    ${previewOverlay}
                    <div class="flex items-center justify-between px-3 py-2 border rounded-xl hover:bg-gray-50 transition-colors">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                <span class="text-gray-500 text-lg">üë§</span>
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <a href="user.html?u=${encodeURIComponent(u.id)}" class="font-medium text-gray-800">@${u.display_name || 'User'}</a>
                                    <span class="text-xs text-gray-500 bg-blue-100 px-2 py-1 rounded">User</span>
                                    ${isPreview ? '<span class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded">Preview</span>' : ''}
                                </div>
                                <div class="text-xs text-gray-500 truncate">${u.display_name || ''}</div>
                                ${u.email && !isPreview ? `<div class="text-xs text-gray-600 mt-1">${u.email}</div>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${isPreview ? 
                                `<a href="login.html" class="text-xs px-3 py-1 rounded-full border border-orange-300 text-orange-600 hover:bg-orange-50 transition-colors">Login to Message</a>` :
                                `<a class="text-xs px-3 py-1 rounded-full border border-gray-300 hover:bg-gray-100 transition-colors" href="messages.html?to=${encodeURIComponent(u.id)}">Message</a>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderPost(p, isPreview = false){
            const previewClass = isPreview ? 'opacity-75' : '';
            const previewOverlay = isPreview ? `
                <div class="absolute inset-0 bg-gradient-to-t from-white/80 to-transparent rounded-xl pointer-events-none"></div>
            ` : '';
            
            const excerpt = (p.body||'').replace(/\s+/g,' ').slice(0, isPreview ? 60 : 150);
            const t = new Date(p.created_at).toLocaleString();
            const upvotes = p.upvotes || 0;
            
            return `
                <div class="relative ${previewClass}">
                    ${previewOverlay}
                    <a class="block p-3 border rounded-xl hover:bg-gray-50 transition-colors" href="${isPreview ? 'login.html' : `thread.html?id=${p.id}`}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex gap-2">
                                <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Post</div>
                                ${isPreview ? '<div class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded">Preview</div>' : ''}
                            </div>
                            <div class="text-xs text-gray-500">${t}</div>
                        </div>
                        <div class="font-semibold text-gray-800 mb-1">${p.title?escapeHtml(p.title):'Post'}</div>
                        <div class="text-sm text-gray-700 mb-2">${escapeHtml(excerpt)}${excerpt.length === (isPreview ? 60 : 150) ? '‚Ä¶' : ''}</div>
                        <div class="flex items-center text-xs text-gray-500">
                            ${!isPreview ? `<span class="mr-3">üëç ${upvotes}</span>` : ''}
                            <span>üìù Forum</span>
                            ${isPreview ? '<span class="ml-auto text-orange-600">Login to see full post</span>' : ''}
                        </div>
                    </a>
                </div>
            `;
        }
        
        function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
        
        // Initialize search if query parameter exists
        const qp = new URLSearchParams(location.search); 
        if(qp.get('q')){ 
            q.value = qp.get('q'); 
            run(); 
        }
        
        // Add filter change listeners
        [fUsers,fPosts,fRecent,fTrending].forEach(x=>x.addEventListener('change', run));
    </script>
</body>
</html>



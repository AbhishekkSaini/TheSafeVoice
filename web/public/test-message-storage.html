<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Message Storage - SafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">Test Message Storage</h1>
        
        <div id="test-results" class="space-y-4"></div>
        
        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-semibold mb-4">Manual Test</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Receiver ID:</label>
                    <input id="receiver-id" type="text" class="w-full p-2 border rounded" placeholder="Enter user ID">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Message:</label>
                    <input id="message-text" type="text" class="w-full p-2 border rounded" placeholder="Enter message">
                </div>
            </div>
            <button id="send-test" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Send Test Message
            </button>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-semibold mb-4">Stored Messages</h2>
            <div id="stored-messages" class="space-y-2"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase, getUser } from './js/supabase.js';
        initSupabase();

        const testResults = document.getElementById('test-results');
        const storedMessages = document.getElementById('stored-messages');
        const sendTestBtn = document.getElementById('send-test');
        const receiverIdInput = document.getElementById('receiver-id');
        const messageTextInput = document.getElementById('message-text');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            testResults.appendChild(div);
        }

        async function runTests() {
            addResult('Starting message storage tests...', 'info');
            
            try {
                // Test 1: Check if user is authenticated
                const user = await getUser();
                if (!user) {
                    addResult('❌ User not authenticated. Please login first.', 'error');
                    return;
                }
                addResult('✅ User authenticated: ' + user.email, 'success');
                
                // Test 2: Check if messages table exists
                const { data: messages, error: messagesError } = await supabase
                    .from('messages')
                    .select('count')
                    .limit(1);
                
                if (messagesError) {
                    addResult('❌ Messages table error: ' + messagesError.message, 'error');
                } else {
                    addResult('✅ Messages table accessible', 'success');
                }
                
                // Test 3: Check if functions exist
                try {
                    const { data: conversations, error: convError } = await supabase
                        .rpc('get_recent_conversations', { limit_count: 5, offset_count: 0 });
                    
                    if (convError) {
                        addResult('❌ get_recent_conversations function error: ' + convError.message, 'error');
                    } else {
                        addResult('✅ get_recent_conversations function working', 'success');
                    }
                } catch (e) {
                    addResult('❌ Function test failed: ' + e.message, 'error');
                }
                
                // Test 4: Check if user has any messages
                const { data: userMessages, error: userMsgError } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (userMsgError) {
                    addResult('❌ User messages query error: ' + userMsgError.message, 'error');
                } else {
                    addResult(`✅ Found ${userMessages.length} messages for user`, 'success');
                    displayMessages(userMessages);
                }
                
            } catch (e) {
                addResult('❌ Test failed: ' + e.message, 'error');
            }
        }

        function displayMessages(messages) {
            storedMessages.innerHTML = '';
            
            if (messages.length === 0) {
                storedMessages.innerHTML = '<p class="text-gray-500">No messages found</p>';
                return;
            }
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded bg-gray-50';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <strong>From:</strong> ${msg.sender_id}<br>
                            <strong>To:</strong> ${msg.receiver_id}<br>
                            <strong>Message:</strong> ${msg.body}<br>
                            <strong>Status:</strong> ${msg.status || 'unknown'}
                        </div>
                        <div class="text-sm text-gray-500">
                            ${new Date(msg.created_at).toLocaleString()}
                        </div>
                    </div>
                `;
                storedMessages.appendChild(div);
            });
        }

        // Manual test
        sendTestBtn.addEventListener('click', async () => {
            const receiverId = receiverIdInput.value.trim();
            const messageText = messageTextInput.value.trim();
            
            if (!receiverId || !messageText) {
                addResult('❌ Please enter both receiver ID and message', 'error');
                return;
            }
            
            try {
                const user = await getUser();
                if (!user) {
                    addResult('❌ User not authenticated', 'error');
                    return;
                }
                
                // Send message using optimistic function
                const { data, error } = await supabase.rpc('send_message_optimistic', {
                    p_receiver_id: receiverId,
                    p_body: messageText,
                    p_temp_id: 'test_' + Date.now()
                });
                
                if (error) {
                    addResult('❌ Send message error: ' + error.message, 'error');
                } else {
                    addResult('✅ Message sent successfully! ID: ' + data.id, 'success');
                    
                    // Refresh messages display
                    const { data: userMessages } = await supabase
                        .from('messages')
                        .select('*')
                        .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
                        .order('created_at', { ascending: false })
                        .limit(10);
                    
                    displayMessages(userMessages);
                }
            } catch (e) {
                addResult('❌ Test send failed: ' + e.message, 'error');
            }
        });

        // Run tests on page load
        runTests();
    </script>
</body>
</html>

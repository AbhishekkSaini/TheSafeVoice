<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complete Message Storage - SafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">Test Complete Message Storage (Instagram-Style)</h1>
        
        <div id="test-results" class="space-y-4"></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
            <!-- Send Message Test -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Send Message Test</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Receiver ID:</label>
                        <input id="receiver-id" type="text" class="w-full p-2 border rounded" placeholder="Enter user ID">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Message:</label>
                        <textarea id="message-text" class="w-full p-2 border rounded" rows="3" placeholder="Enter message"></textarea>
                    </div>
                    <button id="send-test" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Send Message (Instagram-Style)
                    </button>
                </div>
            </div>
            
            <!-- Conversation List Test -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold mb-4">Conversation List Test</h2>
                <button id="load-conversations" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mb-4">
                    Load Conversation List
                </button>
                <div id="conversation-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
        </div>
        
        <!-- Message History Test -->
        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-semibold mb-4">Message History Test</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">User ID for History:</label>
                    <input id="history-user-id" type="text" class="w-full p-2 border rounded" placeholder="Enter user ID">
                </div>
                <div class="flex items-end">
                    <button id="load-history" class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        Load Message History
                    </button>
                </div>
            </div>
            <div id="message-history" class="space-y-2 max-h-64 overflow-y-auto"></div>
        </div>
        
        <!-- Stored Messages Overview -->
        <div class="bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-xl font-semibold mb-4">All Stored Messages</h2>
            <button id="refresh-messages" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 mb-4">
                Refresh All Messages
            </button>
            <div id="all-messages" class="space-y-2 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase, getUser } from './js/supabase.js';
        initSupabase();

        const testResults = document.getElementById('test-results');
        const sendTestBtn = document.getElementById('send-test');
        const loadConversationsBtn = document.getElementById('load-conversations');
        const loadHistoryBtn = document.getElementById('load-history');
        const refreshMessagesBtn = document.getElementById('refresh-messages');
        const conversationList = document.getElementById('conversation-list');
        const messageHistory = document.getElementById('message-history');
        const allMessages = document.getElementById('all-messages');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            testResults.appendChild(div);
        }

        async function runInitialTests() {
            addResult('Starting complete message storage tests...', 'info');
            
            try {
                // Test 1: Check if user is authenticated
                const user = await getUser();
                if (!user) {
                    addResult('‚ùå User not authenticated. Please login first.', 'error');
                    return;
                }
                addResult('‚úÖ User authenticated: ' + user.email, 'success');
                
                // Test 2: Check if new functions exist
                try {
                    const { data: conversations, error: convError } = await supabase
                        .rpc('get_conversation_list', { limit_count: 5, offset_count: 0 });
                    
                    if (convError) {
                        addResult('‚ùå get_conversation_list function error: ' + convError.message, 'error');
                    } else {
                        addResult('‚úÖ get_conversation_list function working', 'success');
                    }
                } catch (e) {
                    addResult('‚ùå Function test failed: ' + e.message, 'error');
                }
                
                // Test 3: Check if send_message_with_storage exists
                try {
                    const { data, error } = await supabase.rpc('send_message_with_storage', {
                        p_receiver_id: user.id,
                        p_body: 'Test message for function check',
                        p_temp_id: 'test_' + Date.now()
                    });
                    
                    if (error) {
                        addResult('‚ùå send_message_with_storage function error: ' + error.message, 'error');
                    } else {
                        addResult('‚úÖ send_message_with_storage function working', 'success');
                    }
                } catch (e) {
                    addResult('‚ùå Send function test failed: ' + e.message, 'error');
                }
                
            } catch (e) {
                addResult('‚ùå Test failed: ' + e.message, 'error');
            }
        }

        // Send message test
        sendTestBtn.addEventListener('click', async () => {
            const receiverId = document.getElementById('receiver-id').value.trim();
            const messageText = document.getElementById('message-text').value.trim();
            
            if (!receiverId || !messageText) {
                addResult('‚ùå Please enter both receiver ID and message', 'error');
                return;
            }
            
            try {
                const user = await getUser();
                if (!user) {
                    addResult('‚ùå User not authenticated', 'error');
                    return;
                }
                
                addResult('üì§ Sending message with Instagram-style storage...', 'info');
                
                // Send message using new function
                const { data, error } = await supabase.rpc('send_message_with_storage', {
                    p_receiver_id: receiverId,
                    p_body: messageText,
                    p_temp_id: 'test_' + Date.now()
                });
                
                if (error) {
                    addResult('‚ùå Send message error: ' + error.message, 'error');
                } else {
                    addResult('‚úÖ Message sent and stored successfully! ID: ' + data.id, 'success');
                    addResult('‚úÖ Conversation ID: ' + data.conversation_id, 'success');
                    addResult('‚úÖ Message will be retrievable later like Instagram!', 'success');
                    
                    // Clear input
                    document.getElementById('message-text').value = '';
                    
                    // Refresh all displays
                    loadAllMessages();
                }
            } catch (e) {
                addResult('‚ùå Test send failed: ' + e.message, 'error');
            }
        });

        // Load conversation list
        loadConversationsBtn.addEventListener('click', async () => {
            try {
                addResult('üìã Loading conversation list...', 'info');
                
                const { data: conversations, error } = await supabase
                    .rpc('get_conversation_list', { limit_count: 20, offset_count: 0 });
                
                if (error) {
                    addResult('‚ùå Load conversations error: ' + error.message, 'error');
                } else {
                    addResult(`‚úÖ Loaded ${conversations.length} conversations`, 'success');
                    displayConversations(conversations);
                }
            } catch (e) {
                addResult('‚ùå Load conversations failed: ' + e.message, 'error');
            }
        });

        // Load message history
        loadHistoryBtn.addEventListener('click', async () => {
            const userId = document.getElementById('history-user-id').value.trim();
            
            if (!userId) {
                addResult('‚ùå Please enter user ID for history', 'error');
                return;
            }
            
            try {
                addResult('üìú Loading message history...', 'info');
                
                const { data: messages, error } = await supabase
                    .rpc('get_message_history', { 
                        other_user_id: userId, 
                        limit_count: 50, 
                        offset_count: 0 
                    });
                
                if (error) {
                    addResult('‚ùå Load history error: ' + error.message, 'error');
                } else {
                    addResult(`‚úÖ Loaded ${messages.length} messages from history`, 'success');
                    displayMessageHistory(messages);
                }
            } catch (e) {
                addResult('‚ùå Load history failed: ' + e.message, 'error');
            }
        });

        // Refresh all messages
        refreshMessagesBtn.addEventListener('click', loadAllMessages);

        function displayConversations(conversations) {
            conversationList.innerHTML = '';
            
            if (conversations.length === 0) {
                conversationList.innerHTML = '<p class="text-gray-500">No conversations found</p>';
                return;
            }
            
            conversations.forEach(conv => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded bg-gray-50';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <strong>${conv.other_user_name}</strong><br>
                            <small class="text-gray-600">ID: ${conv.other_user_id}</small><br>
                            <span class="text-sm">${conv.last_message || 'No messages yet'}</span><br>
                            <span class="text-xs text-gray-500">${conv.unread_count} unread</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500">${conv.last_message_time ? new Date(conv.last_message_time).toLocaleString() : 'Never'}</div>
                            <div class="w-2 h-2 rounded-full ${conv.is_online ? 'bg-green-500' : 'bg-gray-400'} mt-1"></div>
                        </div>
                    </div>
                `;
                conversationList.appendChild(div);
            });
        }

        function displayMessageHistory(messages) {
            messageHistory.innerHTML = '';
            
            if (messages.length === 0) {
                messageHistory.innerHTML = '<p class="text-gray-500">No messages found</p>';
                return;
            }
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded bg-gray-50';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <strong>Message:</strong> ${msg.body}<br>
                            <small class="text-gray-600">From: ${msg.sender_id}</small><br>
                            <small class="text-gray-600">Status: ${msg.status || 'unknown'}</small>
                        </div>
                        <div class="text-sm text-gray-500">
                            ${new Date(msg.created_at).toLocaleString()}
                        </div>
                    </div>
                `;
                messageHistory.appendChild(div);
            });
        }

        async function loadAllMessages() {
            try {
                const user = await getUser();
                if (!user) return;
                
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`sender_id.eq.${user.id},receiver_id.eq.${user.id}`)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (error) {
                    addResult('‚ùå Load all messages error: ' + error.message, 'error');
                } else {
                    displayAllMessages(messages);
                }
            } catch (e) {
                addResult('‚ùå Load all messages failed: ' + e.message, 'error');
            }
        }

        function displayAllMessages(messages) {
            allMessages.innerHTML = '';
            
            if (messages.length === 0) {
                allMessages.innerHTML = '<p class="text-gray-500">No messages found</p>';
                return;
            }
            
            messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'p-3 border rounded bg-gray-50';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <strong>From:</strong> ${msg.sender_id}<br>
                            <strong>To:</strong> ${msg.receiver_id}<br>
                            <strong>Message:</strong> ${msg.body}<br>
                            <strong>Status:</strong> ${msg.status || 'unknown'}<br>
                            <strong>Temp ID:</strong> ${msg.temp_id || 'none'}
                        </div>
                        <div class="text-sm text-gray-500">
                            ${new Date(msg.created_at).toLocaleString()}
                        </div>
                    </div>
                `;
                allMessages.appendChild(div);
            });
        }

        // Run initial tests
        runInitialTests();
    </script>
</body>
</html>

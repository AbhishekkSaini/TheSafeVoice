<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
    <title>Real-time Chat - SafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .message { margin: 8px 0; padding: 12px; border-radius: 12px; max-width: 70%; }
        .message-sent { background: #3b82f6; color: white; margin-left: auto; }
        .message-received { background: #e5e7eb; color: #374151; }
        .typing-indicator { color: #6b7280; font-style: italic; }
        .online-indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online { background: #10b981; }
        .offline { background: #9ca3af; }
        .chat-container { height: 500px; overflow-y: auto; }
        .status-bar { background: #f9fafb; border-bottom: 1px solid #e5e7eb; padding: 8px 16px; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-center">Real-time Chat Demo</h1>
        
        <!-- Connection Status -->
        <div id="connection-status" class="bg-white p-4 rounded-lg shadow-md mb-6">
            <h2 class="text-lg font-semibold mb-2">Connection Status</h2>
            <div id="status-info" class="text-sm text-gray-600">Initializing...</div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Chat Interface -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <!-- Status Bar -->
                    <div class="status-bar">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="online-indicator" id="user-status"></span>
                                <span id="chat-user-name">Select a user to start chatting</span>
                            </div>
                            <div class="text-sm text-gray-500" id="typing-status"></div>
                        </div>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chat-messages" class="chat-container p-4 space-y-2">
                        <div class="text-center text-gray-500 text-sm">
                            Select a user from the list to start chatting
                        </div>
                    </div>
                    
                    <!-- Message Input -->
                    <div class="p-4 border-t">
                        <form id="message-form" class="flex gap-2">
                            <input 
                                type="text" 
                                id="message-input" 
                                placeholder="Type your message..." 
                                class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                disabled
                            >
                            <button 
                                type="submit" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50"
                                disabled
                            >
                                Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- User List -->
            <div class="bg-white rounded-lg shadow-md p-4">
                <h2 class="text-lg font-semibold mb-4">Online Users</h2>
                <div id="user-list" class="space-y-2">
                    <div class="text-gray-500 text-sm">Loading users...</div>
                </div>
            </div>
        </div>
        
        <!-- Debug Info -->
        <div class="bg-white rounded-lg shadow-md p-4 mt-6">
            <h2 class="text-lg font-semibold mb-2">Debug Information</h2>
            <div id="debug-info" class="text-sm text-gray-600 space-y-1"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase, getUser } from 'js/supabase.js';
        import realtimeMessaging from 'js/realtime-messaging.js';
        
        initSupabase();
        
        let currentChatUser = null;
        let messageHistory = [];
        
        // DOM elements
        const statusInfo = document.getElementById('status-info');
        const chatMessages = document.getElementById('chat-messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const userList = document.getElementById('user-list');
        const chatUserName = document.getElementById('chat-user-name');
        const userStatus = document.getElementById('user-status');
        const typingStatus = document.getElementById('typing-status');
        const debugInfo = document.getElementById('debug-info');
        
        // Initialize real-time messaging
        async function initializeRealtime() {
            try {
                statusInfo.textContent = 'Connecting to real-time service...';
                
                const success = await realtimeMessaging.initialize();
                if (success) {
                    statusInfo.innerHTML = '<span class="text-green-600">✅ Connected to real-time messaging</span>';
                    setupEventListeners();
                    loadUsers();
                } else {
                    statusInfo.innerHTML = '<span class="text-red-600">❌ Failed to connect</span>';
                }
            } catch (error) {
                console.error('Failed to initialize realtime:', error);
                statusInfo.innerHTML = '<span class="text-red-600">❌ Connection error</span>';
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Listen for new messages
            realtimeMessaging.onMessage((message, type) => {
                console.log('Received message:', message, type);
                if (type === 'new' && message.sender_id === currentChatUser?.id) {
                    addMessageToChat(message, 'received');
                }
                updateDebugInfo();
            });
            
            // Listen for typing indicators
            realtimeMessaging.onTyping((typingData) => {
                if (typingData.user_id === currentChatUser?.id) {
                    if (typingData.is_typing) {
                        typingStatus.textContent = 'Typing...';
                    } else {
                        typingStatus.textContent = '';
                    }
                }
            });
            
            // Listen for online status changes
            realtimeMessaging.onOnlineStatus((onlineData) => {
                updateUserOnlineStatus(onlineData);
            });
            
            // Message form submission
            messageForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message || !currentChatUser) return;
                
                try {
                    // Send typing indicator (stop typing)
                    await realtimeMessaging.sendTypingIndicator(currentChatUser.id, false);
                    
                    // Send message
                    const sentMessage = await realtimeMessaging.sendMessage(currentChatUser.id, message);
                    addMessageToChat(sentMessage, 'sent');
                    
                    messageInput.value = '';
                } catch (error) {
                    console.error('Failed to send message:', error);
                    alert('Failed to send message: ' + error.message);
                }
            });
            
            // Typing indicator
            let typingTimeout;
            messageInput.addEventListener('input', async () => {
                if (!currentChatUser) return;
                
                // Send typing indicator
                await realtimeMessaging.sendTypingIndicator(currentChatUser.id, true);
                
                // Clear previous timeout
                clearTimeout(typingTimeout);
                
                // Stop typing indicator after 2 seconds
                typingTimeout = setTimeout(async () => {
                    await realtimeMessaging.sendTypingIndicator(currentChatUser.id, false);
                }, 2000);
            });
        }
        
        // Load users
        async function loadUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('profiles')
                    .select('id, display_name')
                    .neq('id', (await getUser()).id);
                
                if (error) throw error;
                
                userList.innerHTML = '';
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer';
                    userDiv.innerHTML = `
                        <div class="flex items-center">
                            <span class="online-indicator offline" id="status-${user.id}"></span>
                            <span>${user.display_name || 'User ' + user.id.slice(0, 8)}</span>
                        </div>
                    `;
                    userDiv.addEventListener('click', () => selectUser(user));
                    userList.appendChild(userDiv);
                });
                
                // Check online status for each user
                users.forEach(checkUserOnlineStatus);
                
            } catch (error) {
                console.error('Failed to load users:', error);
                userList.innerHTML = '<div class="text-red-500">Failed to load users</div>';
            }
        }
        
        // Check if user is online
        async function checkUserOnlineStatus(user) {
            try {
                const { data, error } = await supabase
                    .from('online_users')
                    .select('is_online, last_seen')
                    .eq('user_id', user.id)
                    .single();
                
                if (!error && data) {
                    const isOnline = data.is_online && 
                        new Date(data.last_seen) > new Date(Date.now() - 5 * 60 * 1000); // 5 minutes
                    
                    const statusElement = document.getElementById(`status-${user.id}`);
                    if (statusElement) {
                        statusElement.className = `online-indicator ${isOnline ? 'online' : 'offline'}`;
                    }
                }
            } catch (error) {
                console.error('Failed to check online status:', error);
            }
        }
        
        // Select user to chat with
        async function selectUser(user) {
            currentChatUser = user;
            chatUserName.textContent = user.display_name || 'User ' + user.id.slice(0, 8);
            userStatus.className = `online-indicator ${document.getElementById(`status-${user.id}`).classList.contains('online') ? 'online' : 'offline'}`;
            
            // Enable message input
            messageInput.disabled = false;
            messageForm.querySelector('button').disabled = false;
            
            // Load message history
            await loadMessageHistory(user.id);
            
            // Mark messages as read
            await realtimeMessaging.markMessagesAsRead(user.id);
        }
        
        // Load message history
        async function loadMessageHistory(userId) {
            try {
                const { data: messages, error } = await supabase.rpc('get_message_history', {
                    other_user_id: userId,
                    limit_count: 50,
                    offset_count: 0
                });
                
                if (error) throw error;
                
                messageHistory = messages;
                displayMessages(messages);
                
            } catch (error) {
                console.error('Failed to load message history:', error);
                chatMessages.innerHTML = '<div class="text-red-500">Failed to load messages</div>';
            }
        }
        
        // Display messages
        function displayMessages(messages) {
            chatMessages.innerHTML = '';
            messages.forEach(message => {
                const isSent = message.sender_id === currentChatUser.id;
                addMessageToChat(message, isSent ? 'sent' : 'received', false);
            });
        }
        
        // Add message to chat
        function addMessageToChat(message, type, scroll = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `
                <div class="font-medium text-xs mb-1">${type === 'sent' ? 'You' : (currentChatUser?.display_name || 'User')}</div>
                <div>${escapeHtml(message.body)}</div>
                <div class="text-xs opacity-70 mt-1">${new Date(message.created_at).toLocaleTimeString()}</div>
            `;
            chatMessages.appendChild(messageDiv);
            
            if (scroll) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Update user online status
        function updateUserOnlineStatus(onlineData) {
            const statusElement = document.getElementById(`status-${onlineData.user_id}`);
            if (statusElement) {
                const isOnline = onlineData.is_online && 
                    new Date(onlineData.last_seen) > new Date(Date.now() - 5 * 60 * 1000);
                
                statusElement.className = `online-indicator ${isOnline ? 'online' : 'offline'}`;
                
                // Update current chat user status if applicable
                if (currentChatUser?.id === onlineData.user_id) {
                    userStatus.className = `online-indicator ${isOnline ? 'online' : 'offline'}`;
                }
            }
        }
        
        // Update debug info
        function updateDebugInfo() {
            const status = realtimeMessaging.getConnectionStatus();
            debugInfo.innerHTML = `
                <div>Connected: ${status.isConnected ? 'Yes' : 'No'}</div>
                <div>User ID: ${status.currentUser || 'None'}</div>
                <div>Active subscriptions: ${status.activeSubscriptions}</div>
                <div>Current chat user: ${currentChatUser?.id || 'None'}</div>
                <div>Messages in history: ${messageHistory.length}</div>
            `;
        }
        
        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize
        initializeRealtime();
        
        // Update debug info periodically
        setInterval(updateDebugInfo, 5000);
    </script>
</body>
</html>

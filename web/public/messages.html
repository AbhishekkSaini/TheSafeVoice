<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - TheSafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .message-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }
        .online-dot {
            background: #00d2d3;
        }
        .typing-indicator {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #666;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Instagram-style message bubbles */
        .my-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .other-message {
            background: #f1f1f1;
            color: #262626;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Solid backgrounds to fix transparency */
        .conversation-item {
            background: white !important;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .conversation-item:hover {
            background: #f8f9fa !important;
        }
        
        .chat-container {
            background: white !important;
        }
        
        .message-input-container {
            background: white !important;
            border-top: 1px solid #e5e5e5;
        }
        
        /* Ensure all backgrounds are solid */
        .bg-white {
            background-color: white !important;
        }
        
        .chat-messages {
            background: white !important;
        }
    </style>
</head>
<body class="font-sans bg-white h-screen overflow-hidden">
    <!-- Instagram-style Navigation -->
    <nav class="bg-white border-b border-gray-200 h-16 flex items-center px-6 shadow-sm">
        <div class="flex items-center justify-between w-full max-w-6xl mx-auto">
            <!-- Logo -->
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg flex items-center justify-center mr-3">
                    <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                </div>
                <span class="text-xl font-bold text-gray-900">SafeVoice</span>
            </div>

            <!-- Search Bar -->
            <div class="flex-1 max-w-md mx-8">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input id="global-search" placeholder="Search" class="w-full bg-gray-100 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
            </div>

            <!-- Navigation Icons -->
            <div class="flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="home" class="w-6 h-6"></i>
                </a>
                <a href="forum.html" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="compass" class="w-6 h-6"></i>
                </a>
                <div class="relative">
                    <button id="messages-icon" class="text-gray-600 hover:text-gray-900 relative">
                        <i data-lucide="send" class="w-6 h-6"></i>
                        <span id="message-badge" class="message-badge absolute -top-2 -right-2 w-5 h-5 rounded-full text-white text-xs flex items-center justify-center font-bold hidden">0</span>
                    </button>
                </div>
                <a href="profile.html" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex h-[calc(100vh-4rem)]">
        <!-- Left Sidebar - Conversations -->
        <div class="w-80 border-r border-gray-200 flex flex-col bg-white">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 bg-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Messages</h2>
                    <button id="new-message-btn" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                        <i data-lucide="edit-3" class="w-4 h-4 text-gray-600"></i>
                    </button>
                </div>
            </div>

            <!-- Search Users -->
            <div id="search-section" class="p-4 border-b border-gray-200 bg-white hidden">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input id="user-search" placeholder="Search users..." class="w-full bg-gray-100 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div id="search-results" class="mt-2 space-y-1"></div>
            </div>

            <!-- Conversations List -->
            <div id="conversations-list" class="flex-1 overflow-y-auto bg-white">
                <div id="no-conversations" class="p-8 text-center text-gray-500 bg-white">
                    <i data-lucide="send" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium mb-2">Your messages</p>
                    <p class="text-sm">Send private messages to friends</p>
                    <button id="start-messaging-btn" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send message
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Side - Chat Area -->
        <div class="flex-1 flex flex-col bg-white">
            <!-- Chat Header -->
            <div id="chat-header" class="h-16 border-b border-gray-200 flex items-center px-6 bg-white hidden">
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div id="online-indicator" class="online-dot absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white hidden"></div>
                    </div>
                    <div>
                        <h3 id="chat-user-name" class="font-semibold text-gray-900">User Name</h3>
                        <p id="chat-user-status" class="text-sm text-gray-500">offline</p>
                    </div>
                </div>
                <div class="ml-auto">
                    <button id="chat-info-btn" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center">
                        <i data-lucide="info" class="w-4 h-4 text-gray-600"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white hidden">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="px-6 py-2 bg-white hidden">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-gray-500"></i>
                    </div>
                    <div class="other-message px-4 py-2">
                        <div class="flex space-x-1">
                            <div class="typing-indicator"></div>
                            <div class="typing-indicator"></div>
                            <div class="typing-indicator"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div id="message-input" class="message-input-container p-4 hidden">
                <div class="flex items-center space-x-3">
                    <button id="emoji-btn" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center">
                        <i data-lucide="smile" class="w-4 h-4 text-gray-600"></i>
                    </button>
                    <button id="attach-btn" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center">
                        <i data-lucide="paperclip" class="w-4 h-4 text-gray-600"></i>
                    </button>
                    <div class="flex-1 relative">
                        <input id="message-text" placeholder="Message..." class="w-full bg-gray-100 rounded-full px-4 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        <button id="send-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-6 h-6 rounded-full bg-blue-500 hover:bg-blue-600 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="send" class="w-3 h-3 text-white"></i>
                        </button>
                    </div>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*,video/*,audio/*">
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex-1 flex items-center justify-center bg-white">
                <div class="text-center">
                    <i data-lucide="send" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Your messages</h3>
                    <p class="text-gray-500 mb-4">Send private photos and messages to a friend or group.</p>
                    <button id="send-message-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase, getUser } from './js/supabase.js';
        initSupabase();
        window.lucide && window.lucide.createIcons();

        let me = null;
        let currentChat = null;
        let conversations = new Map();
        let typingTimer = null;
        let onlineStatusTimer = null;
        let typingChannel = null;
        let messageChannel = null;
        let onlineChannel = null;
        let unreadCount = 0;

        // DOM elements
        const conversationsList = document.getElementById('conversations-list');
        const noConversations = document.getElementById('no-conversations');
        const searchSection = document.getElementById('search-section');
        const searchResults = document.getElementById('search-results');
        const userSearch = document.getElementById('user-search');
        const chatHeader = document.getElementById('chat-header');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const messageInput = document.getElementById('message-input');
        const emptyState = document.getElementById('empty-state');
        const messageText = document.getElementById('message-text');
        const sendBtn = document.getElementById('send-btn');
        const messageBadge = document.getElementById('message-badge');
        const newMessageBtn = document.getElementById('new-message-btn');
        const startMessagingBtn = document.getElementById('start-messaging-btn');
        const sendMessageBtn = document.getElementById('send-message-btn');

        // Initialize
        async function init() {
            me = await getUser();
            if (!me) {
                window.location.href = 'login.html';
                return;
            }

            startOnlineStatus();
            await loadConversations();
            setupEventListeners();
            setupRealtimeSubscriptions();
            updateMessageBadge();
        }

        // Start online status updates
        function startOnlineStatus() {
            const updateStatus = async () => {
                try {
                    await supabase.rpc('update_online_status');
                } catch (e) {
                    console.warn('Failed to update online status:', e);
                }
            };
            
            updateStatus();
            onlineStatusTimer = setInterval(updateStatus, 30000);
        }

        // Load conversations
        async function loadConversations() {
            try {
                const { data: messages } = await supabase
                    .from('messages')
                    .select(`
                        id, body, created_at, sender_id, receiver_id, read_at,
                        sender:profiles!messages_sender_id_fkey(id, display_name, online_status, last_seen),
                        receiver:profiles!messages_receiver_id_fkey(id, display_name, online_status, last_seen)
                    `)
                    .or(`sender_id.eq.${me.id},receiver_id.eq.${me.id}`)
                    .order('created_at', { ascending: false });

                if (!messages || messages.length === 0) {
                    showNoConversations();
                    return;
                }

                // Group by conversation partner
                const conversationMap = new Map();
                messages.forEach(msg => {
                    const otherId = msg.sender_id === me.id ? msg.receiver_id : msg.sender_id;
                    const otherUser = msg.sender_id === me.id ? msg.receiver : msg.sender;
                    
                    if (!conversationMap.has(otherId)) {
                        conversationMap.set(otherId, {
                            lastMessage: msg,
                            otherUser: otherUser,
                            unreadCount: 0
                        });
                    }
                    
                    // Count unread messages
                    if (msg.sender_id === otherId && msg.receiver_id === me.id && !msg.read_at) {
                        conversationMap.get(otherId).unreadCount++;
                    }
                });

                conversations = conversationMap;
                renderConversations();
            } catch (e) {
                console.error('Failed to load conversations:', e);
            }
        }

        // Setup real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Listen for new messages
            messageChannel = supabase.channel('messages')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'messages'
                }, async (payload) => {
                    const message = payload.new;
                    console.log('New message received:', message);
                    
                    // If it's a message to/from us, update conversations
                    if (message.sender_id === me.id || message.receiver_id === me.id) {
                        await loadConversations();
                        updateMessageBadge();
                        
                        // If we're in the chat with this user, add the message immediately
                        if (currentChat && (message.sender_id === currentChat.id || message.receiver_id === currentChat.id)) {
                            appendMessage(message);
                        }
                    }
                })
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'messages'
                }, async (payload) => {
                    const message = payload.new;
                    console.log('Message updated:', message);
                    
                    // Update message status (read/delivered)
                    if (currentChat && (message.sender_id === currentChat.id || message.receiver_id === currentChat.id)) {
                        updateMessageStatus(message);
                    }
                })
                .subscribe((status) => {
                    console.log('Message channel status:', status);
                });
        }

        // Show no conversations state
        function showNoConversations() {
            noConversations.classList.remove('hidden');
            conversationsList.innerHTML = '';
            conversationsList.appendChild(noConversations);
        }

        // Render conversations
        function renderConversations() {
            if (conversations.size === 0) {
                showNoConversations();
                return;
            }

            noConversations.classList.add('hidden');
            const conversationsHTML = Array.from(conversations.values())
                .map(conv => renderConversationItem(conv))
                .join('');

            conversationsList.innerHTML = conversationsHTML;
            
            // Add click listeners
            Array.from(conversationsList.querySelectorAll('[data-conversation]')).forEach(btn => {
                btn.addEventListener('click', () => openConversation(btn.getAttribute('data-conversation')));
            });
        }

        // Render conversation item
        function renderConversationItem(conv) {
            const otherUser = conv.otherUser;
            const isOnline = otherUser.online_status && 
                new Date(otherUser.last_seen) > new Date(Date.now() - 5 * 60 * 1000);
            
            const timeAgo = getTimeAgo(conv.lastMessage.created_at);
            const messagePreview = conv.lastMessage.body || 'Sent a message';
            const isFromMe = conv.lastMessage.sender_id === me.id;
            
            return `
                <div data-conversation="${otherUser.id}" class="conversation-item flex items-center p-4 hover:bg-gray-50 cursor-pointer">
                    <div class="relative mr-3">
                        <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
                            <i data-lucide="user" class="w-6 h-6 text-gray-500"></i>
                        </div>
                        ${isOnline ? '<div class="online-dot absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-gray-900 truncate">${otherUser.display_name || 'User'}</h4>
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-gray-600 truncate">
                                ${isFromMe ? 'You: ' : ''}${messagePreview}
                            </p>
                            ${conv.unreadCount > 0 ? `<span class="message-badge text-xs px-2 py-1 rounded-full">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Open conversation
        async function openConversation(userId) {
            try {
                const conv = conversations.get(userId);
                if (!conv) return;

                currentChat = conv.otherUser;
                
                // Update UI
                chatHeader.classList.remove('hidden');
                chatMessages.classList.remove('hidden');
                messageInput.classList.remove('hidden');
                emptyState.classList.add('hidden');

                // Update header
                const isOnline = currentChat.online_status && 
                    new Date(currentChat.last_seen) > new Date(Date.now() - 5 * 60 * 1000);
                
                document.getElementById('chat-user-name').textContent = currentChat.display_name || 'User';
                document.getElementById('chat-user-status').textContent = isOnline ? 'online' : 'offline';
                document.getElementById('online-indicator').classList.toggle('hidden', !isOnline);

                // Load messages
                await loadMessages();

                // Mark messages as read
                await supabase.rpc('mark_messages_read', { other_user_id: userId });
                conv.unreadCount = 0;
                updateMessageBadge();

                // Setup real-time for this conversation
                setupConversationRealtime();

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (e) {
                console.error('Failed to open conversation:', e);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const { data: messages } = await supabase
                    .from('messages')
                    .select('*')
                    .or(`and(sender_id.eq.${me.id},receiver_id.eq.${currentChat.id}),and(sender_id.eq.${currentChat.id},receiver_id.eq.${me.id})`)
                    .order('created_at', { ascending: true });

                chatMessages.innerHTML = (messages || []).map(m => renderMessage(m)).join('');
            } catch (e) {
                console.error('Failed to load messages:', e);
            }
        }

        // Render message with Instagram-style bubbles
        function renderMessage(m) {
            const isMine = m.sender_id === me.id;
            const isRead = m.read_at !== null;
            const isDelivered = m.delivered_at !== null;
            
            let status = '';
            if (isMine) {
                if (isRead) {
                    status = '✓✓'; // Read
                } else if (isDelivered) {
                    status = '✓✓'; // Delivered
                } else {
                    status = '✓'; // Sent
                }
            }

            const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            return `
                <div class="flex ${isMine ? 'justify-end' : 'justify-start'} mb-3" data-message-id="${m.id}">
                    <div class="max-w-[70%]">
                        <div class="flex items-end space-x-2 ${isMine ? 'flex-row-reverse space-x-reverse' : ''}">
                            ${!isMine ? '<div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><i data-lucide="user" class="w-3 h-3 text-gray-500"></i></div>' : ''}
                            <div class="${isMine ? 'my-message' : 'other-message'} px-4 py-2">
                                <p class="text-sm font-medium">${escapeHtml(m.body)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 mt-1 ${isMine ? 'justify-end' : 'justify-start'}">
                            <span class="text-xs text-gray-500">${time}</span>
                            ${isMine ? `<span class="text-xs text-gray-500 message-status">${status}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Append message to chat
        function appendMessage(m) {
            chatMessages.insertAdjacentHTML('beforeend', renderMessage(m));
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Update message status
        function updateMessageStatus(message) {
            const messageEl = chatMessages.querySelector(`[data-message-id="${message.id}"]`);
            if (messageEl) {
                const statusEl = messageEl.querySelector('.message-status');
                if (statusEl) {
                    const isRead = message.read_at !== null;
                    const isDelivered = message.delivered_at !== null;
                    
                    if (isRead) {
                        statusEl.textContent = '✓✓';
                    } else if (isDelivered) {
                        statusEl.textContent = '✓✓';
                    } else {
                        statusEl.textContent = '✓';
                    }
                }
            }
        }

        // Setup real-time for current conversation
        function setupConversationRealtime() {
            if (typingChannel) typingChannel.unsubscribe();
            if (onlineChannel) onlineChannel.unsubscribe();

            // Typing indicator
            typingChannel = supabase.channel(`typing:${me.id}:${currentChat.id}`)
                .on('broadcast', { event: 'typing' }, (payload) => {
                    if (payload.userId !== me.id) {
                        showTyping();
                    }
                })
                .subscribe();

            // Online status
            onlineChannel = supabase.channel(`online:${currentChat.id}`)
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'profiles',
                    filter: `id.eq.${currentChat.id}`
                }, (payload) => {
                    updateOnlineStatus(payload.new);
                })
                .subscribe();
        }

        // Show typing indicator
        function showTyping() {
            typingIndicator.classList.remove('hidden');
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                typingIndicator.classList.add('hidden');
            }, 3000);
        }

        // Update online status
        function updateOnlineStatus(user) {
            const isOnline = user.online_status && 
                new Date(user.last_seen) > new Date(Date.now() - 5 * 60 * 1000);
            
            document.getElementById('chat-user-status').textContent = isOnline ? 'online' : 'offline';
            document.getElementById('online-indicator').classList.toggle('hidden', !isOnline);
        }

        // Send message
        async function sendMessage() {
            if (!currentChat) return;
            
            const text = messageText.value.trim();
            if (!text) return;
            
            try {
                const { data, error } = await supabase.from('messages').insert({
                    sender_id: me.id,
                    receiver_id: currentChat.id,
                    body: text
                }).select();
                
                if (error) throw error;
                
                messageText.value = '';
                sendBtn.disabled = true;
                
                // Add message to chat immediately
                if (data && data[0]) {
                    appendMessage(data[0]);
                }
                
                // Mark as delivered
                await supabase.rpc('mark_messages_delivered', { other_user_id: currentChat.id });
                
                // Reload conversations to update the list
                await loadConversations();
            } catch (e) {
                alert('Failed to send message: ' + e.message);
            }
        }

        // Search users
        async function searchUsers(query) {
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }
            
            try {
                const { data: users } = await supabase
                    .from('profiles')
                    .select('id, display_name, online_status, last_seen')
                    .ilike('display_name', `%${query}%`)
                    .limit(10);
                
                if (!users || users.length === 0) {
                    searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">No users found</div>';
                    return;
                }
                
                searchResults.innerHTML = users.map(user => {
                    const isOnline = user.online_status && 
                        new Date(user.last_seen) > new Date(Date.now() - 5 * 60 * 1000);
                    
                    return `
                        <div class="flex items-center p-3 hover:bg-gray-50 cursor-pointer bg-white" data-user-id="${user.id}">
                            <div class="relative mr-3">
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                    <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                                </div>
                                ${isOnline ? '<div class="online-dot absolute bottom-0 right-0 w-2 h-2 rounded-full border border-white"></div>' : ''}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">${user.display_name || 'User'}</h4>
                                <p class="text-sm text-gray-500">${isOnline ? 'online' : 'offline'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click listeners
                Array.from(searchResults.querySelectorAll('[data-user-id]')).forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = btn.getAttribute('data-user-id');
                        startNewConversation(userId);
                    });
                });
            } catch (e) {
                console.error('Failed to search users:', e);
            }
        }

        // Start new conversation
        async function startNewConversation(userId) {
            try {
                const { data: user } = await supabase
                    .from('profiles')
                    .select('id, display_name, online_status, last_seen')
                    .eq('id', userId)
                    .single();

                if (!user) return;

                // Add to conversations if not exists
                if (!conversations.has(userId)) {
                    conversations.set(userId, {
                        lastMessage: null,
                        otherUser: user,
                        unreadCount: 0
                    });
                }

                // Hide search
                searchSection.classList.add('hidden');
                userSearch.value = '';
                searchResults.innerHTML = '';

                // Open conversation
                await openConversation(userId);
            } catch (e) {
                console.error('Failed to start conversation:', e);
            }
        }

        // Update message badge
        function updateMessageBadge() {
            unreadCount = Array.from(conversations.values())
                .reduce((total, conv) => total + conv.unreadCount, 0);
            
            if (unreadCount > 0) {
                messageBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                messageBadge.classList.remove('hidden');
            } else {
                messageBadge.classList.add('hidden');
            }
        }

        // Utility functions
        function getTimeAgo(date) {
            const now = new Date();
            const messageDate = new Date(date);
            const diffMs = now - messageDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}d`;
            return messageDate.toLocaleDateString();
        }

        function escapeHtml(s = '') {
            return s.replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Send message
            sendBtn.addEventListener('click', sendMessage);
            messageText.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Enable/disable send button
            messageText.addEventListener('input', () => {
                sendBtn.disabled = !messageText.value.trim();
            });

            // Typing indicator
            messageText.addEventListener('input', () => {
                if (typingChannel && currentChat) {
                    try {
                        typingChannel.send({
                            type: 'broadcast',
                            event: 'typing',
                            payload: { userId: me.id }
                        });
                    } catch (e) {
                        console.warn('Failed to send typing indicator:', e);
                    }
                }
            });

            // New message button
            newMessageBtn.addEventListener('click', () => {
                searchSection.classList.toggle('hidden');
                userSearch.focus();
            });

            // Start messaging buttons
            startMessagingBtn.addEventListener('click', () => {
                searchSection.classList.remove('hidden');
                userSearch.focus();
            });

            sendMessageBtn.addEventListener('click', () => {
                searchSection.classList.remove('hidden');
                userSearch.focus();
            });

            // User search
            userSearch.addEventListener('input', (e) => {
                searchUsers(e.target.value);
            });

            // Emoji and attach buttons
            document.getElementById('emoji-btn').addEventListener('click', () => {
                messageText.value += '😊';
                messageText.focus();
            });

            document.getElementById('attach-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (onlineStatusTimer) clearInterval(onlineStatusTimer);
            if (typingChannel) typingChannel.unsubscribe();
            if (messageChannel) messageChannel.unsubscribe();
            if (onlineChannel) onlineChannel.unsubscribe();
        });

        // Initialize
        init();
    </script>
</body>
</html>



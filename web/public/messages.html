<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - TheSafeVoice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .message-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }
        .online-dot {
            background: #00d2d3;
        }
        .typing-indicator {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #666;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Instagram-style message bubbles */
        .my-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .other-message {
            background: #f1f1f1;
            color: #262626;
            border-radius: 18px 18px 18px 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Solid backgrounds */
        .conversation-item {
            background: white !important;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .conversation-item:hover {
            background: #f8f9fa !important;
        }
        
        .chat-container {
            background: white !important;
        }
        
        .message-input-container {
            background: white !important;
            border-top: 1px solid #e5e5e5;
        }
        
        .bg-white {
            background-color: white !important;
        }
        
        .chat-messages {
            background: white !important;
        }
        
        /* Optimistic message styling */
        .message-sending {
            opacity: 0.7;
        }
        
        .message-sent {
            opacity: 1;
        }
        
        /* Multi-line input support */
        .message-input {
            resize: none;
            min-height: 40px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        /* Smooth scrolling */
        .chat-messages {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="font-sans bg-white h-screen overflow-hidden">
    <!-- Instagram-style Navigation -->
    <nav class="bg-white border-b border-gray-200 h-16 flex items-center px-6 shadow-sm">
        <div class="flex items-center justify-between w-full max-w-6xl mx-auto">
            <!-- Logo -->
            <div class="flex items-center">
                <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg flex items-center justify-center mr-3">
                    <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                </div>
                <span class="text-xl font-bold text-gray-900">SafeVoice</span>
            </div>

            <!-- Search Bar -->
            <div class="flex-1 max-w-md mx-8">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input id="global-search" placeholder="Search" class="w-full bg-gray-100 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
            </div>

            <!-- Navigation Icons -->
            <div class="flex items-center space-x-6">
                <a href="index.html" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="home" class="w-6 h-6"></i>
                </a>
                <a href="forum.html" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="compass" class="w-6 h-6"></i>
                </a>
                <div class="relative">
                    <button id="messages-icon" class="text-gray-600 hover:text-gray-900 relative">
                        <i data-lucide="send" class="w-6 h-6"></i>
                        <span id="message-badge" class="message-badge absolute -top-2 -right-2 w-5 h-5 rounded-full text-white text-xs flex items-center justify-center font-bold hidden">0</span>
                    </button>
                </div>
                <a href="profile.html" class="text-gray-600 hover:text-gray-900">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex h-[calc(100vh-4rem)]">
        <!-- Left Sidebar - Conversations -->
        <div class="w-80 border-r border-gray-200 flex flex-col bg-white">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 bg-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Messages</h2>
                    <button id="new-message-btn" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center">
                        <i data-lucide="edit-3" class="w-4 h-4 text-gray-600"></i>
                    </button>
                </div>
            </div>

            <!-- Search Users -->
            <div id="search-section" class="p-4 border-b border-gray-200 bg-white hidden">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                    <input id="user-search" placeholder="Search users..." class="w-full bg-gray-100 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div id="search-results" class="mt-2 space-y-1"></div>
            </div>

            <!-- Conversations List -->
            <div id="conversations-list" class="flex-1 overflow-y-auto bg-white">
                <div id="no-conversations" class="p-8 text-center text-gray-500 bg-white">
                    <i data-lucide="send" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium mb-2">Your messages</p>
                    <p class="text-sm">Send private messages to friends</p>
                    <button id="start-messaging-btn" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send message
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Side - Chat Area -->
        <div class="flex-1 flex flex-col bg-white">
            <!-- Chat Header -->
            <div id="chat-header" class="h-16 border-b border-gray-200 flex items-center px-6 bg-white hidden">
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div id="online-indicator" class="online-dot absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white hidden"></div>
                    </div>
                    <div>
                        <h3 id="chat-user-name" class="font-semibold text-gray-900">User Name</h3>
                        <p id="chat-user-status" class="text-sm text-gray-500">offline</p>
                    </div>
                </div>
                <div class="ml-auto">
                    <button id="chat-info-btn" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center">
                        <i data-lucide="info" class="w-4 h-4 text-gray-600"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white hidden">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="px-6 py-2 bg-white hidden">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center">
                        <i data-lucide="user" class="w-4 h-4 text-gray-500"></i>
                    </div>
                    <div class="other-message px-4 py-2">
                        <div class="flex space-x-1">
                            <div class="typing-indicator"></div>
                            <div class="typing-indicator"></div>
                            <div class="typing-indicator"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div id="message-input" class="message-input-container p-4 hidden">
                <div class="flex items-end space-x-3">
                    <button id="emoji-btn" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="smile" class="w-4 h-4 text-gray-600"></i>
                    </button>
                    <button id="attach-btn" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="paperclip" class="w-4 h-4 text-gray-600"></i>
                    </button>
                    <div class="flex-1 relative">
                        <textarea id="message-text" placeholder="Message..." class="message-input w-full bg-gray-100 rounded-full px-4 py-2 pr-12 focus:outline-none focus:ring-2 focus:ring-orange-500 resize-none" rows="1"></textarea>
                        <button id="send-btn" class="absolute right-2 bottom-2 w-6 h-6 rounded-full bg-blue-500 hover:bg-blue-600 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="send" class="w-3 h-3 text-white"></i>
                        </button>
                    </div>
                </div>
                <input type="file" id="file-input" class="hidden" accept="image/*,video/*,audio/*">
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="flex-1 flex items-center justify-center bg-white">
                <div class="text-center">
                    <i data-lucide="send" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Your messages</h3>
                    <p class="text-gray-500 mb-4">Send private photos and messages to a friend or group.</p>
                    <button id="send-message-btn" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Send message
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script type="module">
        import { initSupabase, supabase, getUser } from './js/supabase.js';
        initSupabase();
        window.lucide && window.lucide.createIcons();

        let me = null;
        let currentChat = null;
        let conversations = new Map();
        let typingTimer = null;
        let onlineStatusTimer = null;
        let messageChannel = null;
        let typingChannel = null;
        let onlineChannel = null;
        let unreadCount = 0;
        let optimisticMessages = new Map(); // Track optimistic messages
        let messageCache = new Map(); // Cache messages for instant loading
        let conversationOffset = 0;
        let messageOffset = 0;
        const MESSAGES_PER_PAGE = 50;
        const CONVERSATIONS_PER_PAGE = 20;

        // DOM elements
        const conversationsList = document.getElementById('conversations-list');
        const noConversations = document.getElementById('no-conversations');
        const searchSection = document.getElementById('search-section');
        const searchResults = document.getElementById('search-results');
        const userSearch = document.getElementById('user-search');
        const chatHeader = document.getElementById('chat-header');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const messageInput = document.getElementById('message-input');
        const emptyState = document.getElementById('empty-state');
        const messageText = document.getElementById('message-text');
        const sendBtn = document.getElementById('send-btn');
        const messageBadge = document.getElementById('message-badge');
        const newMessageBtn = document.getElementById('new-message-btn');
        const startMessagingBtn = document.getElementById('start-messaging-btn');
        const sendMessageBtn = document.getElementById('send-message-btn');

        // Initialize
        async function init() {
            me = await getUser();
            if (!me) {
                window.location.href = 'login.html';
                return;
            }

            startOnlineStatus();
            await loadConversations();
            setupEventListeners();
            setupRealtimeSubscriptions();
            updateMessageBadge();
        }

        // Start online status updates
        function startOnlineStatus() {
            const updateStatus = async () => {
                try {
                    await supabase.rpc('update_online_status');
                } catch (e) {
                    console.warn('Failed to update online status:', e);
                }
            };
            
            updateStatus();
            onlineStatusTimer = setInterval(updateStatus, 30000); // Update every 30 seconds
        }

        // Load conversations with pagination
        async function loadConversations() {
            try {
                const { data: conversations_data } = await supabase.rpc('get_recent_conversations', {
                    limit_count: CONVERSATIONS_PER_PAGE,
                    offset_count: conversationOffset
                });
                
                if (!conversations_data || conversations_data.length === 0) {
                    if (conversationOffset === 0) {
                        showNoConversations();
                    }
                    return;
                }

                // Convert to Map for easier access
                conversations_data.forEach(conv => {
                    conversations.set(conv.other_user_id, {
                        otherUser: {
                            id: conv.other_user_id,
                            display_name: conv.other_user_name,
                            online_status: conv.is_online,
                            last_seen: new Date()
                        },
                        lastMessage: {
                            body: conv.last_message,
                            created_at: conv.last_message_time
                        },
                        unreadCount: conv.unread_count
                    });
                });

                renderConversations();
            } catch (e) {
                console.error('Failed to load conversations:', e);
            }
        }

        // Show no conversations state
        function showNoConversations() {
            noConversations.classList.remove('hidden');
            conversationsList.innerHTML = '';
            conversationsList.appendChild(noConversations);
        }

        // Render conversations
        function renderConversations() {
            if (conversations.size === 0) {
                showNoConversations();
                return;
            }

            noConversations.classList.add('hidden');
            const conversationsHTML = Array.from(conversations.values())
                .map(conv => renderConversationItem(conv))
                .join('');

            conversationsList.innerHTML = conversationsHTML;
            
            // Add click listeners
            Array.from(conversationsList.querySelectorAll('[data-conversation]')).forEach(btn => {
                btn.addEventListener('click', () => openConversation(btn.getAttribute('data-conversation')));
            });
        }

        // Render conversation item
        function renderConversationItem(conv) {
            const otherUser = conv.otherUser;
            const isOnline = otherUser.online_status;
            
            const timeAgo = getTimeAgo(conv.lastMessage.created_at);
            const messagePreview = conv.lastMessage.body || 'Sent a message';
            
            return `
                <div data-conversation="${otherUser.id}" class="conversation-item flex items-center p-4 hover:bg-gray-50 cursor-pointer">
                    <div class="relative mr-3">
                        <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
                            <i data-lucide="user" class="w-6 h-6 text-gray-500"></i>
                        </div>
                        ${isOnline ? '<div class="online-dot absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-gray-900 truncate">${otherUser.display_name || 'User'}</h4>
                            <span class="text-xs text-gray-500">${timeAgo}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <p class="text-sm text-gray-600 truncate">${messagePreview}</p>
                            ${conv.unreadCount > 0 ? `<span class="message-badge text-xs px-2 py-1 rounded-full">${conv.unreadCount}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Open conversation with cached messages
        async function openConversation(userId) {
            try {
                const conv = conversations.get(userId);
                if (!conv) return;

                currentChat = conv.otherUser;
                messageOffset = 0; // Reset pagination
                
                // Update UI
                chatHeader.classList.remove('hidden');
                chatMessages.classList.remove('hidden');
                messageInput.classList.remove('hidden');
                emptyState.classList.add('hidden');

                // Update header
                const isOnline = currentChat.online_status;
                
                document.getElementById('chat-user-name').textContent = currentChat.display_name || 'User';
                document.getElementById('chat-user-status').textContent = isOnline ? 'online' : 'offline';
                document.getElementById('online-indicator').classList.toggle('hidden', !isOnline);

                // Load messages (from cache if available)
                await loadMessages();

                // Mark messages as read
                await supabase.rpc('mark_messages_read', { other_user_id: userId });
                conv.unreadCount = 0;
                updateMessageBadge();

                // Setup real-time for this conversation
                setupConversationRealtime();

                // Focus on input
                messageText.focus();

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (e) {
                console.error('Failed to open conversation:', e);
            }
        }

        // Load messages with caching and pagination
        async function loadMessages() {
            try {
                // Check cache first
                const cacheKey = `messages_${me.id}_${currentChat.id}`;
                if (messageCache.has(cacheKey) && messageOffset === 0) {
                    const cachedMessages = messageCache.get(cacheKey);
                    renderMessages(cachedMessages);
                    
                    // Load fresh data in background
                    loadFreshMessages();
                    return;
                }

                await loadFreshMessages();
            } catch (e) {
                console.error('Failed to load messages:', e);
            }
        }

        // Load fresh messages from database with pagination
        async function loadFreshMessages() {
            const { data: messages } = await supabase.rpc('get_messages', {
                other_user_id: currentChat.id,
                limit_count: MESSAGES_PER_PAGE,
                offset_count: messageOffset
            });

            if (messages) {
                // Reverse messages for proper chronological order
                const reversedMessages = messages.reverse();
                
                if (messageOffset === 0) {
                    // First load - replace all messages
                    const cacheKey = `messages_${me.id}_${currentChat.id}`;
                    messageCache.set(cacheKey, reversedMessages);
                    renderMessages(reversedMessages);
                } else {
                    // Pagination - prepend older messages
                    const cacheKey = `messages_${me.id}_${currentChat.id}`;
                    const existingMessages = messageCache.get(cacheKey) || [];
                    const updatedMessages = [...reversedMessages, ...existingMessages];
                    messageCache.set(cacheKey, updatedMessages);
                    renderMessages(updatedMessages, true); // true = prepend mode
                }
            }
        }

        // Render messages
        function renderMessages(messages, prepend = false) {
            if (prepend) {
                // Store current scroll position
                const scrollHeight = chatMessages.scrollHeight;
                const scrollTop = chatMessages.scrollTop;
                
                // Prepend messages
                const messagesHTML = messages.map(m => renderMessage(m)).join('');
                chatMessages.innerHTML = messagesHTML;
                
                // Maintain scroll position
                const newScrollHeight = chatMessages.scrollHeight;
                chatMessages.scrollTop = scrollTop + (newScrollHeight - scrollHeight);
            } else {
                // Normal render
                chatMessages.innerHTML = messages.map(m => renderMessage(m)).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Render message with Instagram-style bubbles
        function renderMessage(m) {
            const isMine = m.sender_id === me.id;
            const isOptimistic = optimisticMessages.has(m.temp_id);
            
            let status = '';
            if (isMine) {
                if (m.status === 'read') {
                    status = '✓✓'; // Read (blue in real Instagram)
                } else if (m.status === 'delivered') {
                    status = '✓✓'; // Delivered
                } else if (m.status === 'sent') {
                    status = '✓'; // Sent
                } else {
                    status = '⏳'; // Sending
                }
            }

            const time = new Date(m.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const messageClass = isOptimistic ? 'message-sending' : 'message-sent';
            
            return `
                <div class="flex ${isMine ? 'justify-end' : 'justify-start'} mb-3 ${messageClass}" data-message-id="${m.id}" data-temp-id="${m.temp_id || ''}">
                    <div class="max-w-[70%]">
                        <div class="flex items-end space-x-2 ${isMine ? 'flex-row-reverse space-x-reverse' : ''}">
                            ${!isMine ? '<div class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0"><i data-lucide="user" class="w-3 h-3 text-gray-500"></i></div>' : ''}
                            <div class="${isMine ? 'my-message' : 'other-message'} px-4 py-2">
                                <p class="text-sm font-medium">${escapeHtml(m.body)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 mt-1 ${isMine ? 'justify-end' : 'justify-start'}">
                            <span class="text-xs text-gray-500">${time}</span>
                            ${isMine ? `<span class="text-xs text-gray-500 message-status">${status}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Setup real-time subscriptions with focused channels
        function setupRealtimeSubscriptions() {
            // Listen for new messages - filtered by receiver_id for efficiency
            messageChannel = supabase.channel('messages')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'messages',
                    filter: `receiver_id=eq.${me.id}`
                }, async (payload) => {
                    const message = payload.new;
                    console.log('New message received:', message);
                    
                    // Check if this is our optimistic message
                    if (optimisticMessages.has(message.temp_id)) {
                        // Replace optimistic message with real one
                        optimisticMessages.delete(message.temp_id);
                        updateOptimisticMessage(message);
                    } else {
                        // This is a new message from someone else
                        await loadConversations();
                        updateMessageBadge();
                        
                        // If we're in the chat with this user, add the message immediately
                        if (currentChat && message.sender_id === currentChat.id) {
                            appendMessage(message);
                        }
                    }
                })
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'messages',
                    filter: `receiver_id=eq.${me.id}`
                }, async (payload) => {
                    const message = payload.new;
                    console.log('Message updated:', message);
                    
                    // Update message status (read/delivered)
                    if (currentChat && message.sender_id === currentChat.id) {
                        updateMessageStatus(message);
                    }
                })
                .subscribe((status) => {
                    console.log('Message channel status:', status);
                });
        }

        // Update optimistic message with real data
        function updateOptimisticMessage(message) {
            const optimisticEl = chatMessages.querySelector(`[data-temp-id="${message.temp_id}"]`);
            if (optimisticEl) {
                optimisticEl.classList.remove('message-sending');
                optimisticEl.classList.add('message-sent');
                optimisticEl.setAttribute('data-message-id', message.id);
                optimisticEl.removeAttribute('data-temp-id');
                
                // Update status
                const statusEl = optimisticEl.querySelector('.message-status');
                if (statusEl) {
                    statusEl.textContent = '✓'; // Sent
                }
            }
        }

        // Append message to chat
        function appendMessage(m) {
            chatMessages.insertAdjacentHTML('beforeend', renderMessage(m));
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Update cache
            const cacheKey = `messages_${me.id}_${currentChat.id}`;
            if (messageCache.has(cacheKey)) {
                const cachedMessages = messageCache.get(cacheKey);
                cachedMessages.push(m);
                messageCache.set(cacheKey, cachedMessages);
            }
        }

        // Update message status
        function updateMessageStatus(message) {
            const messageEl = chatMessages.querySelector(`[data-message-id="${message.id}"]`);
            if (messageEl) {
                const statusEl = messageEl.querySelector('.message-status');
                if (statusEl) {
                    if (message.status === 'read') {
                        statusEl.textContent = '✓✓';
                        statusEl.style.color = '#0084ff'; // Instagram blue
                    } else if (message.status === 'delivered') {
                        statusEl.textContent = '✓✓';
                    } else if (message.status === 'sent') {
                        statusEl.textContent = '✓';
                    }
                }
            }
        }

        // Setup real-time for current conversation
        function setupConversationRealtime() {
            if (typingChannel) typingChannel.unsubscribe();
            if (onlineChannel) onlineChannel.unsubscribe();

            // Typing indicator - lightweight channel
            typingChannel = supabase.channel(`typing:${me.id}:${currentChat.id}`)
                .on('broadcast', { event: 'typing' }, (payload) => {
                    if (payload.userId !== me.id) {
                        showTyping();
                    }
                })
                .subscribe();

            // Online status - lightweight channel
            onlineChannel = supabase.channel(`online:${currentChat.id}`)
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'online_users',
                    filter: `user_id=eq.${currentChat.id}`
                }, (payload) => {
                    updateOnlineStatus(payload.new);
                })
                .subscribe();
        }

        // Show typing indicator
        function showTyping() {
            typingIndicator.classList.remove('hidden');
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                typingIndicator.classList.add('hidden');
            }, 3000);
        }

        // Update online status
        function updateOnlineStatus(user) {
            const isOnline = user.is_online && 
                new Date(user.last_seen) > new Date(Date.now() - 5 * 60 * 1000);
            
            document.getElementById('chat-user-status').textContent = isOnline ? 'online' : 'offline';
            document.getElementById('online-indicator').classList.toggle('hidden', !isOnline);
        }

        // Send message with optimistic updates
        async function sendMessage() {
            if (!currentChat) return;
            
            const text = messageText.value.trim();
            if (!text) return;
            
            // Generate temp ID for optimistic update
            const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Create optimistic message
            const optimisticMessage = {
                id: tempId,
                temp_id: tempId,
                sender_id: me.id,
                receiver_id: currentChat.id,
                body: text,
                status: 'sending',
                created_at: new Date().toISOString()
            };
            
            // Add to optimistic messages
            optimisticMessages.set(tempId, optimisticMessage);
            
            // Add to UI immediately (optimistic update)
            appendMessage(optimisticMessage);
            
            // Clear input but keep focus
            messageText.value = '';
            messageText.focus();
            
            // Auto-resize textarea
            autoResizeTextarea();
            
            try {
                // Send to database with optimistic function
                const { data, error } = await supabase.rpc('send_message_optimistic', {
                    p_receiver_id: currentChat.id,
                    p_body: text,
                    p_temp_id: tempId
                });
                
                if (error) throw error;
                
                // Update conversations list
                await loadConversations();
                
            } catch (e) {
                console.error('Failed to send message:', e);
                // Remove optimistic message on error
                optimisticMessages.delete(tempId);
                const optimisticEl = chatMessages.querySelector(`[data-temp-id="${tempId}"]`);
                if (optimisticEl) {
                    optimisticEl.remove();
                }
                alert('Failed to send message: ' + e.message);
            }
        }

        // Auto-resize textarea
        function autoResizeTextarea() {
            messageText.style.height = 'auto';
            messageText.style.height = Math.min(messageText.scrollHeight, 120) + 'px';
        }

        // Search users
        async function searchUsers(query) {
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }
            
            try {
                const { data: users } = await supabase
                    .from('profiles')
                    .select('id, display_name')
                    .ilike('display_name', `%${query}%`)
                    .limit(10);
                
                if (!users || users.length === 0) {
                    searchResults.innerHTML = '<div class="p-4 text-center text-gray-500">No users found</div>';
                    return;
                }
                
                searchResults.innerHTML = users.map(user => {
                    return `
                        <div class="flex items-center p-3 hover:bg-gray-50 cursor-pointer bg-white" data-user-id="${user.id}">
                            <div class="relative mr-3">
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                    <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-medium text-gray-900">${user.display_name || 'User'}</h4>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click listeners
                Array.from(searchResults.querySelectorAll('[data-user-id]')).forEach(btn => {
                    btn.addEventListener('click', () => {
                        const userId = btn.getAttribute('data-user-id');
                        startNewConversation(userId);
                    });
                });
            } catch (e) {
                console.error('Failed to search users:', e);
            }
        }

        // Start new conversation
        async function startNewConversation(userId) {
            try {
                const { data: user } = await supabase
                    .from('profiles')
                    .select('id, display_name')
                    .eq('id', userId)
                    .single();

                if (!user) return;

                // Add to conversations if not exists
                if (!conversations.has(userId)) {
                    conversations.set(userId, {
                        otherUser: user,
                        lastMessage: null,
                        unreadCount: 0
                    });
                }

                // Hide search
                searchSection.classList.add('hidden');
                userSearch.value = '';
                searchResults.innerHTML = '';

                // Open conversation
                await openConversation(userId);
            } catch (e) {
                console.error('Failed to start conversation:', e);
            }
        }

        // Update message badge
        function updateMessageBadge() {
            unreadCount = Array.from(conversations.values())
                .reduce((total, conv) => total + conv.unreadCount, 0);
            
            if (unreadCount > 0) {
                messageBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                messageBadge.classList.remove('hidden');
            } else {
                messageBadge.classList.add('hidden');
            }
        }

        // Utility functions
        function getTimeAgo(date) {
            const now = new Date();
            const messageDate = new Date(date);
            const diffMs = now - messageDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'now';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffHours < 24) return `${diffHours}h`;
            if (diffDays < 7) return `${diffDays}d`;
            return messageDate.toLocaleDateString();
        }

        function escapeHtml(s = '') {
            return s.replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        // Setup event listeners
        function setupEventListeners() {
            // Send message
            sendBtn.addEventListener('click', sendMessage);
            messageText.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            messageText.addEventListener('input', () => {
                autoResizeTextarea();
                sendBtn.disabled = !messageText.value.trim();
                
                // Typing indicator
                if (typingChannel && currentChat) {
                    try {
                        supabase.rpc('update_typing_status', {
                            other_user_id: currentChat.id,
                            p_is_typing: true
                        });
                        
                        // Clear typing indicator after 3 seconds
                        clearTimeout(typingTimer);
                        typingTimer = setTimeout(() => {
                            supabase.rpc('update_typing_status', {
                                other_user_id: currentChat.id,
                                p_is_typing: false
                            });
                        }, 3000);
                    } catch (e) {
                        console.warn('Failed to send typing indicator:', e);
                    }
                }
            });

            // New message button
            newMessageBtn.addEventListener('click', () => {
                searchSection.classList.toggle('hidden');
                userSearch.focus();
            });

            // Start messaging buttons
            startMessagingBtn.addEventListener('click', () => {
                searchSection.classList.remove('hidden');
                userSearch.focus();
            });

            sendMessageBtn.addEventListener('click', () => {
                searchSection.classList.remove('hidden');
                userSearch.focus();
            });

            // User search
            userSearch.addEventListener('input', (e) => {
                searchUsers(e.target.value);
            });

            // Emoji and attach buttons
            document.getElementById('emoji-btn').addEventListener('click', () => {
                messageText.value += '😊';
                messageText.focus();
                autoResizeTextarea();
            });

            document.getElementById('attach-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            // Infinite scroll for messages
            chatMessages.addEventListener('scroll', () => {
                if (chatMessages.scrollTop === 0) {
                    // Load more messages when scrolled to top
                    messageOffset += MESSAGES_PER_PAGE;
                    loadFreshMessages();
                }
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (onlineStatusTimer) clearInterval(onlineStatusTimer);
            if (typingChannel) typingChannel.unsubscribe();
            if (messageChannel) messageChannel.unsubscribe();
            if (onlineChannel) onlineChannel.unsubscribe();
        });

        // Initialize
        init();
    </script>
</body>
</html>


